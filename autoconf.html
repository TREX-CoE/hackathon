<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-10-27 Wed 14:12 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Autoconf</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Evgeny Posenitskiy, Anthony Scemama" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="org-html-themes/src/readtheorg_theme/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="org-html-themes/src/readtheorg_theme/css/readtheorg.css"/>
<script type="text/javascript" src="org-html-themes/src/lib/js/jquery.min.js"></script>
<script type="text/javascript" src="org-html-themes/src/lib/js/bootstrap.min.js"></script>
<script type="text/javascript" src="org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Autoconf</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org222e965">1. Introduction</a></li>
<li><a href="#orgc854eea">2. Makefile</a></li>
<li><a href="#orgf1dd345">3. configure</a>
<ul>
<li><a href="#orgfdceafa">3.1. Detecting external dependencies</a></li>
</ul>
</li>
<li><a href="#orgea109e9">4. Conclusion</a></li>
</ul>
</div>
</div>
<p>
This page contains the <a href="https://www.gnu.org/software/autoconf/">GNU Autoconf</a> tutorial, which is the first part of the Autotools tutorial.
</p>

<div id="outline-container-org222e965" class="outline-2">
<h2 id="org222e965"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
Building software on different platforms is a challenging task.
Re-building it a few years later is even more challenging.
</p>

<p>
Things get more complicated when the project introduces external dependencies
(e.g. libraries that are installed independently and outside of the source tree).
Such dependencies can be located with some built-in tools like <code>pkg-config</code>.
One could then modify the compilation flags to explicitly include installation paths, thus making the code compile on the current machine.
This approach works fine as long as the code has to be compiled only locally and as long as the dependency is not moved to a different directory.
However, the installation paths are likely to be different on another machine and the aforementioned build procedure might break.
</p>

<p>
In this tutorial, we will learn how to configure a particular project using Autoconf.
This project consists of several <code>C++</code> source files, which are compiled into a single program using custom <code>Makefile</code>.
We will learn how to configure and test the <code>C++</code> compiler before building the project.
The source files depend on the <a href="https://portal.hdfgroup.org/display/HDF5/HDF5">HDF5 library</a>, which is a good example of external dependency.
We will learn how to automatically locate the HDF5 library using macros.
</p>

<p>
Below is a source tree of our project. Header and source files can be found in the <code>include/</code> and <code>src/</code> directories, respectively.
The <code>tests/</code> directory contains the <code>test_h5.cpp</code> and <code>dataset.hdf5</code> files needed to test compilation of the aforementioned source code.
</p>

<p>
For this tutorial, the contents of the source and header files are not important.
However, it is worth mentioning that they depend on the HDF5 library, which is not included in the source tree.
The goal is to demonstrate how cumbersome configuration/compilation steps can be facilitated by the use of <b><b>Autoconf</b></b>.
</p>


<div class="org-src-container">
<pre class="src src-text">Sherman-Morrison/
&#9500;&#9472; include/
&#9474;  &#9500;&#9472; Helpers.hpp
&#9474;  &#9500;&#9472; SMWB.hpp
&#9474;  &#9500;&#9472; SM_Maroni.hpp
&#9474;  &#9500;&#9472; SM_Standard.hpp
&#9474;  &#9500;&#9472; Woodbury.hpp
&#9500;&#9472; src/
&#9474;  &#9500;&#9472; Helpers.cpp
&#9474;  &#9500;&#9472; SMWB.cpp
&#9474;  &#9500;&#9472; SM_Maroni.cpp
&#9474;  &#9500;&#9472; SM_Standard.cpp
&#9474;  &#9500;&#9472; Woodbury.cpp
&#9500;&#9472; tests/
&#9474;  &#9500;&#9472; test_h5.cpp
&#9474;  &#9500;&#9472; dataset.hdf5
&#9500;&#9472; bin/
&#9500;&#9472; Makefile
&#9500;&#9472; README.md
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc854eea" class="outline-2">
<h2 id="orgc854eea"><span class="section-number-2">2</span> Makefile</h2>
<div class="outline-text-2" id="text-2">
<p>
Below is the <code>Makefile</code> of our project:
</p>

<div class="org-src-container">
<pre class="src src-makefile">## <span style="color: #b22222;">Specify the C++ compiler as well as preprocessor, compiler and linking flags</span>
<span style="color: #a0522d;">CXX</span>      = g++
<span style="color: #a0522d;">CPPFLAGS</span> = -I./include/ -I/usr/include/hdf5/serial
<span style="color: #a0522d;">CXXFLAGS</span> = -g -O2 -std=c++11
<span style="color: #a0522d;">LDFLAGS</span>  = -L/usr/lib/x86_64-linux-gnu/hdf5/serial
<span style="color: #a0522d;">LIBS</span>     = -lhdf5 -lhdf5_cpp -lpthread -lz

## <span style="color: #b22222;">Directory structure</span>
<span style="color: #a0522d;">SRC_DIR</span> := src
<span style="color: #a0522d;">TST_DIR</span> := tests
<span style="color: #a0522d;">INC_DIR</span> := include
<span style="color: #a0522d;">BIN_DIR</span> := bin

<span style="color: #a0522d;">EXEC</span>    := $(<span style="color: #a0522d;">BIN_DIR</span>)/test_h5

## <span style="color: #b22222;">Dependencies</span>
<span style="color: #a0522d;">DEPS_CXX</span> = $(<span style="color: #a0522d;">SRC_DIR</span>)/SM_Maponi.o \
           $(<span style="color: #a0522d;">SRC_DIR</span>)/SM_Standard.o \
           $(<span style="color: #a0522d;">SRC_DIR</span>)/Woodbury.o \
           $(<span style="color: #a0522d;">SRC_DIR</span>)/SMWB.o \
           $(<span style="color: #a0522d;">SRC_DIR</span>)/Helpers.o

## <span style="color: #b22222;">Build tagets</span>
<span style="color: #0000ff;">.PHONY</span>: all clean

<span style="color: #0000ff;">all</span>: $(<span style="color: #a0522d;">EXEC</span>)

<span style="color: #0000ff;">clean</span>:
        <span style="color: #228b22;">@</span>rm -rf -- $(<span style="color: #a0522d;">SRC_DIR</span>)/*.o $(<span style="color: #a0522d;">TST_DIR</span>)/*.o $(<span style="color: #a0522d;">EXEC</span>)

## <span style="color: #b22222;">Compiling dependencies</span>
<span style="color: #0000ff;">.SUFFIXES</span>: .cpp .o

## <span style="color: #b22222;">Linking</span>
<span style="color: #0000ff;">$(</span><span style="color: #0000ff;">BIN_DIR</span><span style="color: #0000ff;">)/test_h5</span>: $(<span style="color: #a0522d;">DEPS_CXX</span>) $(<span style="color: #a0522d;">TST_DIR</span>)/test_h5.o
        $(<span style="color: #a0522d;">CXX</span>) $(<span style="color: #a0522d;">CPPFLAGS</span>) $(<span style="color: #a0522d;">CXXFLAGS</span>) $(<span style="color: #a0522d;">TST_DIR</span>)/test_h5.o $(<span style="color: #a0522d;">DEPS_CXX</span>) -o $(<span style="color: #a0522d;">EXEC</span>) $(<span style="color: #a0522d;">LDFLAGS</span>) $(<span style="color: #a0522d;">LIBS</span>)
</pre>
</div>

<p>
Let's execute <b><b>make</b></b> command and examine the output:
</p>

<pre class="example">
g++ -g -O2 -std=c++11 -I./include/ -I/usr/include/hdf5/serial   -c -o src/SM_Maponi.o src/SM_Maponi.cpp
g++ -g -O2 -std=c++11 -I./include/ -I/usr/include/hdf5/serial   -c -o src/SM_Standard.o src/SM_Standard.cpp
g++ -g -O2 -std=c++11 -I./include/ -I/usr/include/hdf5/serial   -c -o src/Woodbury.o src/Woodbury.cpp
g++ -g -O2 -std=c++11 -I./include/ -I/usr/include/hdf5/serial   -c -o src/SMWB.o src/SMWB.cpp
g++ -g -O2 -std=c++11 -I./include/ -I/usr/include/hdf5/serial   -c -o src/Helpers.o src/Helpers.cpp
g++ -g -O2 -std=c++11 -I./include/ -I/usr/include/hdf5/serial   -c -o tests/test_h5.o tests/test_h5.cpp
g++ -I./include/ -I/usr/include/hdf5/serial  -g -O2 -std=c++11 tests/test_h5.o src/SM_Maponi.o src/SM_Standard.o src/Woodbury.o src/SMWB.o src/Helpers.o -o bin/test_h5  -L/usr/lib/x86_64-linux-gnu/hdf5/serial -lhdf5 -lhdf5_cpp -lpthread -lz 
</pre>

<p>
So it works. We can already see that <code>.o</code> object files are compiled first since they are indicated as dependencies
of the <code>$(BIN_DIR)/test_h5</code> target, which is compiled and linked at the very end.
</p>

<p>
Let's have a look at the following part of our <code>Makefile</code>:
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span style="color: #a0522d;">CXX</span>      = g++
<span style="color: #a0522d;">CXXFLAGS</span> = -g -O2 -std=c++11
<span style="color: #a0522d;">CPPFLAGS</span> = -I./include/ -I/usr/include/hdf5/serial
<span style="color: #a0522d;">LDFLAGS</span>  = -L/usr/lib/x86_64-linux-gnu/hdf5/serial
<span style="color: #a0522d;">LIBS</span>     = -lhdf5 -lhdf5_cpp -lpthread -lz
</pre>
</div>

<p>
<b><b>Question:</b></b> What are advantages and disadvantages of specifying compiler flags as above? 
</p>

<p>
Among other things, the crucial issue here is the portability of the hard-coded paths to HDF5 (see <code>CPPFLAGS</code> and <code>LDFLAGS</code>).
</p>

<p>
Moreover, in this example, we provide all the flags already. 
However, in real life, defining them is challenging, especially for programs with external dependencies.
</p>

<p>
Wouldn't it be nice if we could automatize this process? Well, this is where <b><b>Autoconf</b></b> comes into play.
</p>
</div>
</div>

<div id="outline-container-orgf1dd345" class="outline-2">
<h2 id="orgf1dd345"><span class="section-number-2">3</span> configure</h2>
<div class="outline-text-2" id="text-3">
<p>
In this section, we will talk about several files:
</p>

<ul class="org-ul">
<li>configure.ac</li>
<li>configure</li>
<li>Makefile.in</li>
<li>Makefile</li>
</ul>

<p>
The ultimate goal of the <b><b>Autoconf</b></b> is to produce the <b><b>configure</b></b> script based on the <b>configure.ac</b> file.
The <b><b>configure</b></b> script then detects the <b><b>Makefile.in</b></b> file and replaces some variables there to produce
the final <b><b>Makefile</b></b>, which is used to build a project.  
</p>

<p>
TODO: PICTURE HERE
</p>

<p>
Confused? Don't worry, we will start from the minimal example.
</p>

<p>
Let's create the <code>configure.ac</code> file with the following contents:
</p>

<div class="org-src-container">
<pre class="src src-makefile">#                                               <span style="color: #b22222;">-*- Autoconf -*-</span>
# <span style="color: #b22222;">Process this file with autoconf to produce a configure script.</span>

#<span style="color: #b22222;">initialize autoconf</span>
AC_INIT([sherman-morrison], [0.0.1], [])

AC_OUTPUT
</pre>
</div>

<p>
Here we provided the name of our project [sherman-morrison] and the current version [0.0.1] to the <code>AC_INIT</code> macro.
These are now stored in the <code>$PACKAGE_NAME</code> and <code>$PACKAGE_VERSION</code> variables, respectively.
We will not cover the details of the M4 syntax that is used internally by the Autoconf.
For more information, see the <a href="https://www.gnu.org/software/autoconf/manual/autoconf-2.69/html_node/index.html">Autoconf documentation page</a>.
</p>

<p>
We know the the source code is written in <code>C++</code>. 
Thus, we would like the Autoconf to find and possibly run some checks 
using the~C++~ compiler that is available on the current machine.
</p>

<p>
Let's add a few additional macros for that and examine their output:
</p>

<div class="org-src-container">
<pre class="src src-makefile">#                                               <span style="color: #b22222;">-*- Autoconf -*-</span>
# <span style="color: #b22222;">Process this file with autoconf to produce a configure script.</span>

#<span style="color: #b22222;">initialize autoconf</span>
AC_INIT([sherman-morrison], [0.0.1], [])

# <span style="color: #b22222;">do the tests with C++ flags</span>
AC_LANG(C++)
# <span style="color: #b22222;">search for the C++ compiler</span>
AC_PROG_CXX
# <span style="color: #b22222;">check if the C++ compiler accepts -c and -o simultaneously</span>
AC_PROG_CXX_C_O

AC_OUTPUT

echo \
<span style="color: #8b2252;">"-------------------------------------------------</span>

<span style="color: #8b2252;">${</span><span style="color: #a0522d;">PACKAGE_NAME</span><span style="color: #8b2252;">} Version ${</span><span style="color: #a0522d;">PACKAGE_VERSION</span><span style="color: #8b2252;">}</span>

<span style="color: #8b2252;">CXX ...........:  ${</span><span style="color: #a0522d;">CXX</span><span style="color: #8b2252;">}</span>
<span style="color: #8b2252;">CXXFLAGS ......:  ${</span><span style="color: #a0522d;">CXXFLAGS</span><span style="color: #8b2252;">}</span>

<span style="color: #8b2252;">--------------------------------------------------"</span>
</pre>
</div>

<p>
The contents of the current directory should be as follows:
</p>

<p>
<code>bin/  configure.ac  include/  Makefile  README.md  src/  tests/</code>
</p>

<p>
Now run <code>autoreconf</code> command in your terminal and examine the directory again.
After succesfull exection, a <b><b>configure</b></b> shell script should appear.
</p>

<p>
Let's run it by calling <code>./configure</code>. 
Several checks have been performed by <b><b>Autoconf</b></b> and in the end one might get the following:
</p>

<div class="org-src-container">
<pre class="src src-makefile">-------------------------------------------------

sherman-morrison Version 0.0.1

<span style="color: #0000ff;">CXX ...........</span>:  g++
<span style="color: #0000ff;">CXXFLAGS ......</span>:  -g -O2

--------------------------------------------------
</pre>
</div>

<p>
In the example of output above, the <b><b>configure</b></b> script has detected <code>g++</code> compiler and expanded the
<code>${CXX}</code> variable with the corresponding compiler name. 
Moreover, the script detects the defaul <code>C++</code> compiler flags of <code>g++</code> and adds them to <code>${CXXFLAGS}</code>.
</p>

<p>
From now on we will work mostly with shell variables and call to the Autoconf macros.
</p>

<p>
<i>Note</i>: whenever you make a change in <code>configure.ac</code>, 
execute <code>autoreconf -i</code> to update the generated <code>configure</code> script.
</p>

<p>
The <b><b>configure</b></b> script can also define its own variables (e.g. <code>$PACKAGE_NAME</code> above) and pass them to other files.
To benefit from the previously detected <code>C++</code> compiler and its flags, let's propagate them to <code>Makefile</code>.
</p>

<p>
This requires 2 actions:
</p>

<ul class="org-ul">
<li>Move <code>Makefile</code> to <code>Makefile.in</code> (this is the standard naming convention in Autotools) and replace the hard-coded variables with the ones defined by <b><b>configure</b></b>. For example, <code>CXX = g++</code> should be replaced by <code>CXX = @CXX@</code>. Variables in between <code>@</code> signs are called substitutation variables.</li>
<li>Indicate to Autoconf that <code>Makefile</code> is now its responsibility (due to the variables that will be substituted by <code>./configure</code> call) by adding <code>AC_CONFIG_FILES([Makefile])</code>.</li>
</ul>

<p>
<code>configure.ac</code>:
</p>
<div class="org-src-container">
<pre class="src src-makefile">#                                               <span style="color: #b22222;">-*- Autoconf -*-</span>
# <span style="color: #b22222;">Process this file with autoconf to produce a configure script.</span>

#<span style="color: #b22222;">initialize autoconf</span>
AC_INIT([sherman-morrison], [0.0.1], [])

# <span style="color: #b22222;">do the tests with C++ flags</span>
AC_LANG(C++)
# <span style="color: #b22222;">search for the C++ compiler</span>
AC_PROG_CXX
# <span style="color: #b22222;">check if the C++ compiler accepts -c and -o simultaneously</span>
AC_PROG_CXX_C_O

AC_CONFIG_FILES([Makefile])

AC_OUTPUT

echo \
<span style="color: #8b2252;">"-------------------------------------------------</span>

<span style="color: #8b2252;">${</span><span style="color: #a0522d;">PACKAGE_NAME</span><span style="color: #8b2252;">} Version ${</span><span style="color: #a0522d;">PACKAGE_VERSION</span><span style="color: #8b2252;">}</span>

<span style="color: #8b2252;">CXX ...........:  ${</span><span style="color: #a0522d;">CXX</span><span style="color: #8b2252;">}</span>
<span style="color: #8b2252;">CXXFLAGS ......:  ${</span><span style="color: #a0522d;">CXXFLAGS</span><span style="color: #8b2252;">}</span>

<span style="color: #8b2252;">--------------------------------------------------"</span>
</pre>
</div>

<p>
<code>Makefile.in</code> (only the top part has to be changed):
</p>
<div class="org-src-container">
<pre class="src src-makefile"><span style="color: #a0522d;">CXX</span>      = @CXX@
<span style="color: #a0522d;">CXXFLAGS</span> = @CXXFLAGS@ -std=c++11
<span style="color: #a0522d;">CPPFLAGS</span> = -I./include/ -I/usr/include/hdf5/serial
<span style="color: #a0522d;">LDFLAGS</span>  = -L/usr/lib/x86_64-linux-gnu/hdf5/serial
<span style="color: #a0522d;">LIBS</span>     = -lhdf5 -lhdf5_cpp -lpthread -lz
...........
</pre>
</div>

<p>
Let's reconfigure (<code>autoreconf -i &amp;&amp; ./configure</code>) and examine the changes between the input
<code>Makefile.in</code> and output <code>Makefile</code> (you can use <code>diff</code> or <code>vimdiff</code> for example):
</p>

<div class="org-src-container">
<pre class="src src-shell">$ diff Makefile.in Makefile

&lt; CXX      = @CXX@
&lt; CXXFLAGS = @CXXFLAGS@ -std=c++11
---
&gt; CXX      = g++
&gt; CXXFLAGS = -g -O2 -std=c++11
</pre>
</div>

<p>
This tells us that the substitution variables <code>@CXX@</code> and <code>@CXXFLAGS@</code> have been replaced 
by <code>g++</code> and <code>-g -O2</code>, respectively.
</p>

<p>
Good, but we still have these hard-coded paths to HDF5 library in <code>CPPFLAGS</code> and <code>LDFLAGS</code>.
Let's try to find this library using Autoconf solutions.
</p>
</div>

<div id="outline-container-orgfdceafa" class="outline-3">
<h3 id="orgfdceafa"><span class="section-number-3">3.1</span> Detecting external dependencies</h3>
<div class="outline-text-3" id="text-3-1">
<p>
It is possible to write your our own macros to detect an external dependency.
However, in this example we will try to locate HDF5, which is quite commonly used.
Luckily for us, the GNU website has an <a href="https://www.gnu.org/software/autoconf-archive/The-Macros.html">archive of Autoconf macros</a> for commonly used programs, including HDF5.
The <code>ax_lib_hdf5.m4</code> file can be downloaded from the aforementioned page. 
Autoconf can locate external macros in the root directory of the project or in the <code>m4</code> directory.
The description of this macro can be found <a href="https://www.gnu.org/software/autoconf-archive/ax_lib_hdf5.html">here</a>. Notably, it says:
</p>

<div class="org-src-container">
<pre class="src src-text">If HDF5 is successfully found, this macro calls 

  AC_SUBST(HDF5_VERSION)
  AC_SUBST(HDF5_CC)
  AC_SUBST(HDF5_CFLAGS)
  AC_SUBST(HDF5_CPPFLAGS)
  AC_SUBST(HDF5_LDFLAGS)
  AC_SUBST(HDF5_LIBS)
  AC_SUBST(HDF5_FC)
  AC_SUBST(HDF5_FFLAGS)
  AC_SUBST(HDF5_FLIBS)
  AC_SUBST(HDF5_TYPE)
  AC_DEFINE(HAVE_HDF5)

and sets with_hdf5="yes". ...
</pre>
</div>

<p>
This means that the macro will define a set of variables that can be either manupulated 
within the <code>configure.ac</code> or passed to the <code>Makefile.in</code> via substitution variables. 
In this example, we choose the former and will append the necessary flags with the <code>HDF5_</code> ones.
</p>

<p>
<code>configure.ac</code>:
</p>
<div class="org-src-container">
<pre class="src src-makefile">#                                               <span style="color: #b22222;">-*- Autoconf -*-</span>
# <span style="color: #b22222;">Process this file with autoconf to produce a configure script.</span>

#<span style="color: #b22222;">initialize autoconf</span>
AC_INIT([sherman-morrison], [0.0.1], [])

# <span style="color: #b22222;">do the tests with C++ flags</span>
AC_LANG(C++)
# <span style="color: #b22222;">search for the C++ compiler</span>
AC_PROG_CXX
# <span style="color: #b22222;">check if the C++ compiler accepts -c and -o simultaneously</span>
AC_PROG_CXX_C_O

# <span style="color: #b22222;">call the m4 macro to locate the HDF5 library</span>
AX_LIB_HDF5()

# <span style="color: #b22222;">prepend compiler and linking flags with that of HDF5</span>
<span style="color: #a0522d;">CXXFLAGS</span>=<span style="color: #8b2252;">"${</span><span style="color: #a0522d;">HDF5_CFLAGS</span><span style="color: #8b2252;">} ${</span><span style="color: #a0522d;">CXXFLAGS</span><span style="color: #8b2252;">} -std=c++11"</span>
<span style="color: #a0522d;">CPPFLAGS</span>=<span style="color: #8b2252;">"${</span><span style="color: #a0522d;">HDF5_CPPFLAGS</span><span style="color: #8b2252;">} ${</span><span style="color: #a0522d;">CPPFLAGS</span><span style="color: #8b2252;">} -I./include/"</span>
<span style="color: #a0522d;">LDFLAGS</span>=<span style="color: #8b2252;">"${</span><span style="color: #a0522d;">HDF5_LDFLAGS</span><span style="color: #8b2252;">} ${</span><span style="color: #a0522d;">LDFLAGS</span><span style="color: #8b2252;">}"</span>
<span style="color: #a0522d;">LIBS</span>=<span style="color: #8b2252;">"${</span><span style="color: #a0522d;">HDF5_LIBS</span><span style="color: #8b2252;">} ${</span><span style="color: #a0522d;">LIBS</span><span style="color: #8b2252;">} -lhdf5_cpp"</span>

AC_CONFIG_FILES([Makefile])

AC_OUTPUT

echo \
<span style="color: #8b2252;">"-------------------------------------------------</span>

<span style="color: #8b2252;">${</span><span style="color: #a0522d;">PACKAGE_NAME</span><span style="color: #8b2252;">} Version ${</span><span style="color: #a0522d;">PACKAGE_VERSION</span><span style="color: #8b2252;">}</span>

<span style="color: #8b2252;">CXX ...........:  ${</span><span style="color: #a0522d;">CXX</span><span style="color: #8b2252;">}</span>
<span style="color: #8b2252;">CXXFLAGS ......:  ${</span><span style="color: #a0522d;">CXXFLAGS</span><span style="color: #8b2252;">}</span>
<span style="color: #8b2252;">CPPFLAGS ......:  ${</span><span style="color: #a0522d;">CPPFLAGS</span><span style="color: #8b2252;">}</span>
<span style="color: #8b2252;">LDFLAGS .......:  ${</span><span style="color: #a0522d;">LDFLAGS</span><span style="color: #8b2252;">}</span>
<span style="color: #8b2252;">LIBS ..........:  ${</span><span style="color: #a0522d;">LIBS</span><span style="color: #8b2252;">}</span>

<span style="color: #8b2252;">Package features:</span>
<span style="color: #8b2252;">  Compilation with HDF5 ..:  ${</span><span style="color: #a0522d;">with_hdf5</span><span style="color: #8b2252;">}</span>
<span style="color: #8b2252;">  HDF5 version ...........:  ${</span><span style="color: #a0522d;">HDF5_VERSION</span><span style="color: #8b2252;">}</span>

<span style="color: #8b2252;">--------------------------------------------------"</span>
</pre>
</div>

<p>
<code>Makefile.in</code> (only the top part has to be changed):
</p>
<div class="org-src-container">
<pre class="src src-makefile"><span style="color: #a0522d;">CXX</span>      = @CXX@
<span style="color: #a0522d;">CXXFLAGS</span> = @CXXFLAGS@
<span style="color: #a0522d;">CPPFLAGS</span> = @CPPFLAGS@
<span style="color: #a0522d;">LIBS</span>     = @LIBS@
<span style="color: #a0522d;">LDFLAGS</span>  = @LDFLAGS@
...........
</pre>
</div>

<p>
Now reconfigure and examine the output produced by the <b><b>configure</b></b> script. 
In the end, you will see a more verbose summary of the detected flags and 
newly added package features. The exact output may differ on your machine depending
on the detected compiler and/or the HDF5 library.
</p>

<div class="org-src-container">
<pre class="src src-makefile">-------------------------------------------------

sherman-morrison Version 0.0.1

<span style="color: #0000ff;">CXX ...........</span>:  g++
<span style="color: #0000ff;">CXXFLAGS ......</span>:   -g -O2 -std=c++11
<span style="color: #0000ff;">CPPFLAGS ......</span>:  -I/usr/include -I/usr/include/hdf5/serial  -I./include/
<span style="color: #0000ff;">LDFLAGS .......</span>:   -L/usr/lib/x86_64-linux-gnu/hdf5/serial 
<span style="color: #0000ff;">LIBS ..........</span>:  -lhdf5_hl -lhdf5  -lpthread -lsz -lz -ldl -lm  -lhdf5_cpp

<span style="color: #0000ff;">Package features</span>:
  <span style="color: #0000ff;">Compilation with HDF5 ..</span>:  yes
  <span style="color: #0000ff;">HDF5 version ...........</span>:  1.10.4

--------------------------------------------------
</pre>
</div>

<p>
You can now see how all the hard-coded HDF5 paths have been detected by the <code>ax_lib_hdf5.m4</code> macro.
Moreover, all the flags are propagated to the resulting <code>Makefile</code> thanks to the use of substitution variables.
This can also be checked by visualising differences between <code>Makefile.in</code> and <code>Makefile</code>:
</p>

<div class="org-src-container">
<pre class="src src-shell">$ diff Makefile.in Makefile

&lt; CXX      = @CXX@
&lt; CXXFLAGS = @CXXFLAGS@
&lt; CPPFLAGS = @CPPFLAGS@
&lt; LIBS     = @LIBS@
&lt; LDFLAGS  = @LDFLAGS@
---
&gt; CXX      = g++
&gt; CXXFLAGS =  -g -O2 -std=c++11
&gt; CPPFLAGS = -I/usr/include -I/usr/include/hdf5/serial  -I./include/
&gt; LIBS     = -lhdf5_hl -lhdf5  -lpthread -lsz -lz -ldl -lm  -lhdf5_cpp
&gt; LDFLAGS  =  -L/usr/lib/x86_64-linux-gnu/hdf5/serial 
</pre>
</div>


<p>
<b><b>Note:</b></b> in the example output demonstated in this tutorial, 
the environment was Ubuntu 20.04 OS with HDF5 installed via 
<code>apt-get install libhdf5-dev</code> command.
</p>
</div>
</div>
</div>

<div id="outline-container-orgea109e9" class="outline-2">
<h2 id="orgea109e9"><span class="section-number-2">4</span> Conclusion</h2>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Evgeny Posenitskiy, Anthony Scemama</p>
<p class="date">Created: 2021-10-27 Wed 14:12</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
