<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-11-08 Mon 19:34 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Part II: Automake</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Evgeny Posenitskiy, Anthony Scemama" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="org-html-themes/src/readtheorg_theme/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="org-html-themes/src/readtheorg_theme/css/readtheorg.css"/>
<script type="text/javascript" src="org-html-themes/src/lib/js/jquery.min.js"></script>
<script type="text/javascript" src="org-html-themes/src/lib/js/bootstrap.min.js"></script>
<script type="text/javascript" src="org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="autoconf.html"> UP </a>
 |
 <a accesskey="H" href="index.html"> HOME </a>
</div><div id="content">
<h1 class="title">Part II: Automake</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org648ec26">1. Introduction</a></li>
<li><a href="#org9aebb93">2. GNU coding standards</a>
<ul>
<li><a href="#org62528c2">2.1. Standard targets</a></li>
<li><a href="#org0b2b02f">2.2. Filesystem Hierarchy Standard</a></li>
<li><a href="#org00f3cd0">2.3. Standard <code>Makefile.in</code> variables</a></li>
<li><a href="#orgbc4b079">2.4. Standard environment variables</a></li>
</ul>
</li>
<li><a href="#orgd847792">3. Writing portable Makefiles</a>
<ul>
<li><a href="#org48b2d85">3.1. What you will lose by sticking to the POSIX standard</a></li>
<li><a href="#org52d7394">3.2. Guidelines that will make everything more portable</a></li>
</ul>
</li>
<li><a href="#org4821125">4. Automake basics</a></li>
<li><a href="#org2444173">5. Creating a distributed tarball</a>
<ul>
<li><a href="#org43af10d">5.1. Maintainer mode</a></li>
<li><a href="#org6648a78">5.2. Source distribution targets</a></li>
</ul>
</li>
<li><a href="#org434e7b1">6. Automake Syntax</a>
<ul>
<li><a href="#org2cdd564">6.1. Variables</a></li>
<li><a href="#orga57a59d">6.2. Product list variables</a>
<ul>
<li><a href="#orga73286f">6.2.1. Installation location prefixes</a></li>
<li><a href="#orgc8eded5">6.2.2. Other prefixes</a></li>
<li><a href="#org299a0b5">6.2.3. Primaries</a></li>
</ul>
</li>
<li><a href="#org7e2a50e">6.3. Product source variables</a></li>
<li><a href="#org8fefa51">6.4. PLV and PSV modifiers</a></li>
</ul>
</li>
<li><a href="#org932c970">7. Testing</a></li>
<li><a href="#org2904ecc">8. Using pkg-config</a></li>
<li><a href="#orgfb6ee51">9. Back to Autoconf</a>
<ul>
<li><a href="#org97da41e">9.1. Searching for dependencies</a>
<ul>
<li><a href="#orgaca019d">9.1.1. C definitions</a></li>
<li><a href="#org13cbbf7">9.1.2. Checking for headers</a></li>
<li><a href="#org6c9ee1b">9.1.3. Checking for libraries</a></li>
<li><a href="#orge523e51">9.1.4. Checking for external programs</a></li>
</ul>
</li>
<li><a href="#orgc9fc215">9.2. Printing</a></li>
<li><a href="#org9dca89a">9.3. Using external software</a></li>
</ul>
</li>
<li><a href="#orge334b43">10. Autoscan</a></li>
<li><a href="#org3e46518">11. More about maintainer mode</a>
<ul>
<li><a href="#org0e26bca">11.1. Automatic maintainer/user switching</a></li>
<li><a href="#org6511f1e">11.2. Example: Saving the Git Hash</a></li>
</ul>
</li>
<li><a href="#orgefdad9c">12. Useful links</a></li>
</ul>
</div>
</div>
<p>
This page contains a tutorial on the usage <a href="http://www.gnu.org/software/automake/">GNU Automake</a>.  This is the
second part of the <a href="./index.html">Autotools tutorial</a>.
</p>

<div id="outline-container-org648ec26" class="outline-2">
<h2 id="org648ec26"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
Using a simplified syntax, <b>Automake</b> produces functional Makefiles
which are consistent with the GNU coding standards. This implies that
the Makefiles use standard build targets
(<code class="src src-bash">make install</code>, <code class="src src-bash">make clean</code>, <code class="src src-bash">make dist</code>,
&#x2026;) and standard installation paths (<code>/usr/bin</code>, <code>/usr/share/</code>,
<code>/usr/include</code>, <code>/usr/man</code>, &#x2026;). To avoid struggling too much with
<b>Automake</b>, it is important to understand the usual build, test and
install philosophies common to GNU projects, as well as the underlying
infrastructure managed by <b>Autotools</b>.
</p>

<div class="org-center">

<div class="figure">
<p><img src="./autotools.png" alt="autotools.png" />
</p>
</div>
</div>

<p>
You have seen in the <b>Autoconf</b> tutorial how to write <code>configure.ac</code>
and <code>Makefile.in</code>.  Here, we introduce <b>Automake</b> which will produce
the <code>Makefile.in</code> from a high-level specification file <code>Makefile.am</code>.
The produced file will automatically add extra functionalities to the
Makefile, using standard target names.
</p>
</div>
</div>

<div id="outline-container-org9aebb93" class="outline-2">
<h2 id="org9aebb93"><span class="section-number-2">2</span> GNU coding standards</h2>
<div class="outline-text-2" id="text-2">
<p>
Some aspects of the GNU coding standards (GCS) are well known to
users. If you use them, your users will be grateful because it will
avoid them to read your installation instructions! In addition, it
will make the packaging of your code much simpler if
you want to make it available as a Linux distribution package
(<code>.deb</code>, <code>.rpm</code>, &#x2026;), or as a package for
<a href="https://brew.sh/">Homebrew</a>,
<a href="http://guix.gnu.org/">Guix</a>,
<a href="https://conda.io/">Conda</a>,
<a href="https://spack.io/">Spack</a>,
<a href="https://easybuild.io/">EasyBuild</a>, &#x2026;
</p>

<div class="seealso">
<ul class="org-ul">
<li><a href="https://www.gnu.org/prep/standards/html_node/index.html">GNU coding standards</a></li>
<li><a href="https://coderwall.com/p/urkybq/how-to-create-debian-package-from-source">How to create Debian package from source</a></li>
<li><a href="https://rpm-packaging-guide.github.io/">RPM packaging guide</a></li>
</ul>

</div>
</div>

<div id="outline-container-org62528c2" class="outline-3">
<h3 id="org62528c2"><span class="section-number-3">2.1</span> Standard targets</h3>
<div class="outline-text-3" id="text-2-1">
<p>
The GCS defines standard target names to be included in
Makefiles, such that the behavior of make becomes uniform among
multiple packages. Here is a short list of the main targets:
</p>

<dl class="org-dl">
<dt><code>make all</code></dt><dd>Builds all the targets sufficient to declare the package built.</dd>
<dt><code>make clean</code></dt><dd>Removes all derived files.</dd>
<dt><code>make check</code></dt><dd>Runs unit tests provided by the package.</dd>
<dt><code>make install</code></dt><dd>Installs the package</dd>
<dt><code>make uninstall</code></dt><dd>Uninstalls the package</dd>
<dt><code>make html</code></dt><dd>Builds the documentation in HTML format</dd>
<dt><code>make check</code></dt><dd>Performs self-tests</dd>
</dl>

<div class="seealso">
<ul class="org-ul">
<li><a href="https://www.gnu.org/prep/standards/html_node/Standard-Targets.html#Standard-Targets">Standard targets for users</a></li>
</ul>

</div>
</div>
</div>

<div id="outline-container-org0b2b02f" class="outline-3">
<h3 id="org0b2b02f"><span class="section-number-3">2.2</span> Filesystem Hierarchy Standard</h3>
<div class="outline-text-3" id="text-2-2">
<p>
The Filesystem Hierarchy Standard (FHS) defines the directory
structure and contents in Linux distributions. All Unix-like
systems follow more or less the FHS, which defines standard places
for files like:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Path</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>/bin</code></td>
<td class="org-left">Essential binaries</td>
</tr>

<tr>
<td class="org-left"><code>/lib</code></td>
<td class="org-left">Essential libraries</td>
</tr>

<tr>
<td class="org-left"><code>/etc</code></td>
<td class="org-left">Editable Text Configuration files</td>
</tr>

<tr>
<td class="org-left"><code>/sbin</code></td>
<td class="org-left">Essential system binaries</td>
</tr>

<tr>
<td class="org-left"><code>/share</code></td>
<td class="org-left">Platform-independent files</td>
</tr>

<tr>
<td class="org-left"><code>/tmp</code></td>
<td class="org-left">Directory for temporary files</td>
</tr>

<tr>
<td class="org-left"><code>/usr</code></td>
<td class="org-left">Secondary hierarchy for user data</td>
</tr>

<tr>
<td class="org-left"><code>/usr/bin</code></td>
<td class="org-left">Non-essential binaries</td>
</tr>

<tr>
<td class="org-left"><code>/usr/lib</code></td>
<td class="org-left">Libraries for non-essential binaries</td>
</tr>

<tr>
<td class="org-left"><code>/usr/include</code></td>
<td class="org-left">Standard include files</td>
</tr>

<tr>
<td class="org-left"><code>/usr/local</code></td>
<td class="org-left">Tertiary hierarchy for local data</td>
</tr>
</tbody>
</table>

<p>
It is important to know what these directories contain, because it
will let you know where to install your software and the extra
files that are distributed with it such as the documentation or the
configuration files.
</p>

<div class="seealso">
<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/Filesystem_Hierarchy_Standard">FHS on Wikipedia</a></li>
<li><a href="https://refspecs.linuxfoundation.org/FHS_3.0/fhs-3.0.pdf">FHS specification</a></li>
</ul>

</div>
</div>
</div>

<div id="outline-container-org00f3cd0" class="outline-3">
<h3 id="org00f3cd0"><span class="section-number-3">2.3</span> Standard <code>Makefile.in</code> variables</h3>
<div class="outline-text-3" id="text-2-3">
<p>
Installation directories are named by standard variables, so it
gives the user the flexibility to install the package in a
non-standard place. For example, this feature is required for
packaging where the software is installed in a temporary directory.
</p>

<p>
The main variables are:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Default</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>prefix</code></td>
<td class="org-left"><code>/usr/local</code></td>
<td class="org-left">Root of the hierarchy</td>
</tr>

<tr>
<td class="org-left"><code>exec_prefix</code></td>
<td class="org-left"><code>$(prefix)</code></td>
<td class="org-left">Root of the hierarchy of executable files</td>
</tr>

<tr>
<td class="org-left"><code>bindir</code></td>
<td class="org-left"><code>$(exec_prefix)/bin</code></td>
<td class="org-left">Where to install the binaries</td>
</tr>

<tr>
<td class="org-left"><code>libdir</code></td>
<td class="org-left"><code>$(exec_prefix)/lib</code></td>
<td class="org-left">Where to install the libraries</td>
</tr>

<tr>
<td class="org-left"><code>includedir</code></td>
<td class="org-left"><code>$(prefix)/include</code></td>
<td class="org-left">Where to install include files</td>
</tr>

<tr>
<td class="org-left"><code>datarootdir</code></td>
<td class="org-left"><code>$(prefix)/share</code></td>
<td class="org-left">The root of the platform-independent files</td>
</tr>

<tr>
<td class="org-left"><code>datadir</code></td>
<td class="org-left"><code>$(datarootdir)</code></td>
<td class="org-left">Where to install platform-independent files</td>
</tr>

<tr>
<td class="org-left"><code>mandir</code></td>
<td class="org-left"><code>$(datarootdir)/man</code></td>
<td class="org-left">Where to install platform-independent files</td>
</tr>

<tr>
<td class="org-left"><code>sysconfdir</code></td>
<td class="org-left"><code>$(prefix)/etc</code></td>
<td class="org-left">Where to install configuration files</td>
</tr>

<tr>
<td class="org-left"><code>docdir</code></td>
<td class="org-left"><code>$(datarootdir)/doc/$(package)</code></td>
<td class="org-left">Where to install the documentation</td>
</tr>

<tr>
<td class="org-left"><code>srcdir</code></td>
<td class="org-left">Set by <code>configure</code></td>
<td class="org-left">The directory of the sources being compiled</td>
</tr>
</tbody>
</table>

<p>
In the <code>Makefile.in</code>, these variables may be used between <code>@</code>
symbols, like <code>@bindir@</code> for instance.
</p>

<p>
These variables can take different values by specifying them as
arguments of the <code>configure</code> script:
</p>

<div class="org-src-container">
<pre class="src src-bash">./configure --prefix=$<span style="color: #a0522d;">HOME</span>/install --sysconfdir=$<span style="color: #a0522d;">HOME</span>/.config/
</pre>
</div>

<div class="seealso">
<ul class="org-ul">
<li><a href="https://www.gnu.org/prep/standards/html_node/Directory-Variables.html#Directory-Variables">Directory variables</a></li>
</ul>

</div>
</div>
</div>

<div id="outline-container-orgbc4b079" class="outline-3">
<h3 id="orgbc4b079"><span class="section-number-3">2.4</span> Standard environment variables</h3>
<div class="outline-text-3" id="text-2-4">
<p>
The GCS also defines a set of user-defined environment variables
allowing to change the compilation behavior of the package.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>CC</code></td>
<td class="org-left">C compiler</td>
</tr>

<tr>
<td class="org-left"><code>FC</code></td>
<td class="org-left">Fortran compiler</td>
</tr>

<tr>
<td class="org-left"><code>CXX</code></td>
<td class="org-left">C++ compiler</td>
</tr>

<tr>
<td class="org-left"><code>CPP</code></td>
<td class="org-left">C/C++ preprocessor</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left"><code>CFLAGS</code></td>
<td class="org-left">C compiler flags</td>
</tr>

<tr>
<td class="org-left"><code>FCFLAGS</code></td>
<td class="org-left">Fortran compiler flags</td>
</tr>

<tr>
<td class="org-left"><code>CXXFLAGS</code></td>
<td class="org-left">C++ compiler flags</td>
</tr>

<tr>
<td class="org-left"><code>CPPFLAGS</code></td>
<td class="org-left">C/C++ preprocessor flags</td>
</tr>

<tr>
<td class="org-left"><code>LDFLAGS</code></td>
<td class="org-left">Linker flags</td>
</tr>

<tr>
<td class="org-left"><code>LIBS</code></td>
<td class="org-left">Libraries to add to the linker</td>
</tr>
</tbody>
</table>

<div class="tip">
<p>
To use alternate compiler flags without changing the Makefile, you
can set these variables on the command line as arguments to
<code>make</code>. For example:
</p>

<p>
<code class="src src-bash">make <span style="color: #a0522d;">FC</span>=ifort <span style="color: #a0522d;">FCFLAGS</span>=<span style="color: #8b2252;">"-xAVX -O2"</span></code>
</p>

<p>
You can also do it at configuration time:
</p>

<p>
<code class="src src-bash">./configure <span style="color: #a0522d;">FC</span>=ifort <span style="color: #a0522d;">FCFLAGS</span>=<span style="color: #8b2252;">"-xAVX -O2"</span></code>
</p>

<p>
To see the complete list of user variables, you can run
<code>./configure --help</code>
</p>

</div>
</div>
</div>
</div>

<div id="outline-container-orgd847792" class="outline-2">
<h2 id="orgd847792"><span class="section-number-2">3</span> Writing portable Makefiles</h2>
<div class="outline-text-2" id="text-3">
<p>
The Makefiles produced by <b>Automake</b> are made to be portable among
Linux and Unix systems. Before diving into <b>Automake</b>, we will present
a few techniques to write portable Makefiles.
</p>

<p>
The most popular implementation of <code>make</code> is GNU Make. GNU Make is much more
evolved than the POSIX standard, so Makefiles designed for GNU Make are not
guaranteed to work with alternate implementations of <code>make</code>, such as BSD make for
instance. If you want your software to be <i>really</i> portable, you should stick to the
POSIX standard in your Makefiles by including the line
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span style="color: #0000ff;">.POSIX</span>:
</pre>
</div>

<p>
at the top of your Makefile.
</p>
</div>

<div id="outline-container-org48b2d85" class="outline-3">
<h3 id="org48b2d85"><span class="section-number-3">3.1</span> What you will lose by sticking to the POSIX standard</h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li><p>
Pattern rules, such as
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span style="color: #0000ff;">%_test.o</span>: %_test.c
        $(<span style="color: #a0522d;">CC</span>) $<span style="color: #008b8b;">&lt;</span> -o <span style="color: #0000ff;">$</span><span style="color: #008b8b;">@</span>
</pre>
</div></li>

<li>Special functions <code class="src src-makefile">$(wildcard *.c)</code>, <code class="src src-makefile">$(patsubst %.f, %.o, $(<span style="color: #a0522d;">SRC</span>))</code>, &#x2026;</li>
<li>The ability to have one rule with multiple output files</li>
</ul>
</div>
</div>

<div id="outline-container-org52d7394" class="outline-3">
<h3 id="org52d7394"><span class="section-number-3">3.2</span> Guidelines that will make everything more portable</h3>
<div class="outline-text-3" id="text-3-2">
<ul class="org-ul">
<li>Don't use any other automatic variable than <code>$@</code> (the name of the current target)</li>
<li>Write your scripts with _bash{/bin/sh} instead of <code class="src src-bash">/bin/bash</code></li>
<li>Don't put your compiled files (<code>.o</code>) in a separate location than the source files</li>
<li>Give up writing your Makefiles by hand. Use <b>scripts</b> (Bash, Python) to
write them for you.</li>
<li>Install <code>bmake</code> as an alternative to GNU make to check the portability of
your Makefiles.</li>
<li>Use <code>$(MAKE)</code> in your Makefiles instead of <code>make</code> for recursive builds</li>
<li>Similarly, use POSIX constructs for your shell scripts or shell
constructs in <code>configure.ac</code> (tests with a single square bracket).</li>
</ul>


<div class="seealso">
<ul class="org-ul">
<li><a href="https://pubs.opengroup.org/onlinepubs/9699919799/utilities/make.html">Make's specification</a></li>
<li><a href="http://gnu.ist.utl.pt/software/autoconf/manual/autoconf-2.57/html_chapter/autoconf_10.html">Portable shell programming</a></li>
<li><a href="https://www.oreilly.com/library/view/managing-projects-with/0596006101/ch07.html">Portable Makefiles</a></li>
<li><a href="https://www.gnu.org/savannah-checkouts/gnu/autoconf/manual/autoconf-2.70/html_node/Portable-Make.html#Portable-Make">Portable Make programming</a></li>
</ul>

</div>
</div>
</div>
</div>

<div id="outline-container-org4821125" class="outline-2">
<h2 id="org4821125"><span class="section-number-2">4</span> Automake basics</h2>
<div class="outline-text-2" id="text-4">
<p>
<b>Automake</b> reads a file named <code>Makefile.am</code> and produces the <code>Makefile.in</code>
file. The produced file may contain thousands of lines, and is
guaranteed to have the basic functionalities (<code class="src src-bash">make all</code>,
<code class="src src-bash">make clean</code>, &#x2026;) in a portable Makefile.
<code>Makefile.am</code> contains portable <code>make</code> syntax, and the code it
contains will be inserted at the proper location in the <code>Makefile.in</code>
file.
</p>

<div class="note">
<p>
<b>Automake</b> enables the use of the <code>+=</code> operator, which is an
 extension of the POSIX standard.
</p>

</div>

<p>
We will now create the minimal working example for the code
presented in the <b>Autoconf</b> section. First, inform <b>Autoconf</b> that
you will be using <b>Automake</b> by inserting the <code>AC_INIT_AUTOMAKE</code>
macro in <code>configure.ac</code>:
</p>

<div class="org-src-container">
<pre class="src src-makefile">AC_INIT([sherman-morrison], [0.0.1], [])
AM_INIT_AUTOMAKE([foreign subdir-objects silent-rules])
</pre>
</div>

<p>
The <code>foreign</code> flag informs <b>Autotools</b> that you are not building a
GNU project, otherwise you will be warned that file files <code>NEWS</code>,
<code>README</code>, <code>AUTHORS</code>, <code>ChangeLog</code> and <code>COPYING</code> should be present in
the project.
</p>

<p>
The <code>silent-rules</code> option causes <b>Automake</b> to generate Makefiles
that don't display the complete command line of the actions it
performs, but a less verbose output similar to CMake.
</p>

<p>
The <code>subdir-objects</code> option informs <b>Automake</b> that source files
can be located in subdirectories. It is the case here because all
the source files are located in the <code>src/</code> and <code>tests/</code> directories.
</p>

<div class="tip">
<p>
<b>Autoconf</b> macros start with <code>AC_</code> and <b>Automake</b> macros start with <code>AM_</code>.
</p>

</div>

<p>
Then, create the file <code>Makefile.am</code> with the following content:
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span style="color: #a0522d;">bin_PROGRAMS</span> = test_h5

<span style="color: #a0522d;">test_h5_SOURCES</span> = $(<span style="color: #a0522d;">SOURCES</span>)

<span style="color: #a0522d;">SOURCES</span> = src/SM_Maponi.cpp \
          src/SM_Standard.cpp \
          src/Woodbury.cpp \
          src/SMWB.cpp \
          src/Helpers.cpp \
          tests/test_h5.cpp
</pre>
</div>

<p>
The syntax of this file will be explained in the next section.
</p>

<div class="note">
<p>
In the definition of the <code class="src src-makefile">SOURCES</code> variable, all the
required files are explicitly written. As <b>Automake</b> produces
<i>portable</i> Makefiles, it is not possible to benefit from the GNU
make syntax such as <code class="src src-makefile">$(wildcard src/*.cpp)</code>.
</p>

</div>


<div class="warning">
<p>
<b>Automake</b> will overwrite <code>Makefile.in</code>. Before running <b>Automake</b> the
first time, don't forget to make a backup copy of your <code>Makefile.in</code> file.
</p>

</div>

<p>
We can now create the <code>Makefile.in</code> and the <code>Makefile</code> by running
</p>
<div class="org-src-container">
<pre class="src src-bash">$ autoreconf
$ ./configure
</pre>
</div>

<p>
and build the project
</p>

<div class="org-src-container">
<pre class="src src-bash">$ make
</pre>
</div>

<p>
You can remark that many standard targets are available.
<code>make clean</code> cleans the compiled files, <code>make maintainer-clean</code>
removes more files, including the <code>Makefile</code> and <code>config.status</code>.
</p>

<p>
<b>Automake</b> also provides <code>make install</code> and <code>make uninstall</code>. To
 test it, you can create a directory named <code>_install</code> in the current
 directory and configure the package to be installed in this
 particular directory:
</p>

<div class="org-src-container">
<pre class="src src-bash">$ mkdir _install
$ ./configure --prefix=$<span style="color: #a0522d;">PWD</span>/_install
[...]
$ make install
make[1]: Entering directory <span style="color: #8b2252;">'/home/test/Sherman-Morrison-0.1-demo'</span>
 /bin/mkdir -p <span style="color: #8b2252;">'/home/test/Sherman-Morrison-0.1-demo/_install/bin'</span>
  /usr/bin/install -c test_h5 <span style="color: #8b2252;">'/home/test/Sherman-Morrison-0.1-demo/_install/bin'</span>
make[1]: Nothing to be done for <span style="color: #8b2252;">'install-data-am'</span>.
make[1]: Leaving directory <span style="color: #8b2252;">'/home/test/Sherman-Morrison-0.1-demo'</span>
$ ls _install/
bin
$ ls _install/bin/
test_h5
$ make uninstall
 ( <span style="color: #483d8b;">cd</span> <span style="color: #8b2252;">'/home/test/Sherman-Morrison-0.1-demo/_install/bin'</span> &amp;&amp; rm -f test_h5 )
$ ls _install/bin/
$
</pre>
</div>
</div>
</div>

<div id="outline-container-org2444173" class="outline-2">
<h2 id="org2444173"><span class="section-number-2">5</span> Creating a distributed tarball</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-org43af10d" class="outline-3">
<h3 id="org43af10d"><span class="section-number-3">5.1</span> Maintainer mode</h3>
<div class="outline-text-3" id="text-5-1">
<p>
There are two types of people who will try to compile the source
code:
</p>
<ol class="org-ol">
<li>The end-users having downloaded a tarball with sources</li>
<li>The developers of the code, who produce the source distribution
of the code</li>
</ol>

<p>
These two profiles should be differentiated, because their system
requirements are usually different. The first difference is that the
code developers will need to install <b>Autotools</b> as they will
produce the <code>configure</code> script, but <b>Autotools</b> will not be needed
by the end-users.
</p>

<p>
A more critical example is when complex Makefiles are produced by a
script. The script generating the Makefiles should be stored in the
version control system for developers, as opposed to the generated
Makefiles. For the end-user's point of view, only the generated
Makefiles are needed for the compilation of the sources, and the
script should not be present in the source distribution.
</p>

<p>
To handle these two types of profiles, <b>Autotools</b> provides the
<i>maintainer mode</i>. For instance, in maintainer mode the <code>configure</code>
script is re-generated when <code>configure.ac</code> has changed, as opposed
to standard mode. All these rules are activated in the generated
Makefiles by running
</p>

<div class="org-src-container">
<pre class="src src-bash">./configure --enable-maintainer-mode
</pre>
</div>

<div class="seealso">
<ul class="org-ul">
<li><a href="https://autotools.io/automake/maintainer.html">Maintainer mode and the <code>missing</code> script</a></li>
</ul>

</div>
</div>
</div>

<div id="outline-container-org6648a78" class="outline-3">
<h3 id="org6648a78"><span class="section-number-3">5.2</span> Source distribution targets</h3>
<div class="outline-text-3" id="text-5-2">
<p>
<b>Automake</b> provides automatically the <code>dist</code> target.
<code class="src src-bash">make dist</code> creates a <code>.tar.gz</code> file which contains all the
files necessary to install the package: installation instructions,
<code>configure</code> script, source code, documentation, man pages, unit
tests, etc.
</p>

<div class="org-src-container">
<pre class="src src-bash">$ make dist
[...]
$ tar --list -f sherman-morrison-0.0.1.tar.gz
sherman-morrison-0.0.1/
sherman-morrison-0.0.1/m4/
sherman-morrison-0.0.1/m4/ax_lib_hdf5.m4
sherman-morrison-0.0.1/src/
sherman-morrison-0.0.1/src/SM_Maponi.cpp
sherman-morrison-0.0.1/src/SM_Standard.cpp
sherman-morrison-0.0.1/src/Woodbury.cpp
sherman-morrison-0.0.1/src/SMWB.cpp
sherman-morrison-0.0.1/src/Helpers.cpp
sherman-morrison-0.0.1/tests/
sherman-morrison-0.0.1/tests/test_h5.cpp
sherman-morrison-0.0.1/Makefile.am
sherman-morrison-0.0.1/configure
sherman-morrison-0.0.1/configure.ac
sherman-morrison-0.0.1/aclocal.m4
sherman-morrison-0.0.1/Makefile.in
sherman-morrison-0.0.1/compile
sherman-morrison-0.0.1/depcomp
sherman-morrison-0.0.1/install-sh
sherman-morrison-0.0.1/missing
</pre>
</div>

<div class="question">
<p>
Can you figure out if this archive is OK?
</p>

</div>

<p>
To answer this question, we can use the power of <b>Automake</b> and run
the <code>distcheck</code> target:
</p>

<div class="org-src-container">
<pre class="src src-bash">$ make distcheck
[...]
../../src/SM_Maponi.cpp:4:10: fatal error: SM_Maponi.hpp: No such file or directory
 #<span style="color: #b22222;">include "SM_Maponi.hpp"</span>
          ^~~~~~~~~~~~~~~
compilation terminated.
make[1]: *** [Makefile:449: src/SM_Maponi.o] Error 1
make[1]: Leaving directory <span style="color: #8b2252;">'/home/test/Sherman-Morrison-0.1-demo/sherman-morrison-0.0.1/_build/sub'</span>
make: *** [Makefile:613: distcheck] Error 1
</pre>
</div>

<p>
Oh no! This archive is not valid.  By inspecting the content of the
archive, we notice we forgot to add the header files in the
sources. Although the project builds on our platform, the Makefile
is incomplete because it lacks some dependencies.
</p>

<p>
We can update the <code>SOURCES</code> variables as
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span style="color: #a0522d;">SOURCES</span> = src/SM_Maponi.cpp       \
          src/SM_Standard.cpp     \
          src/Woodbury.cpp        \
          src/SMWB.cpp            \
          src/Helpers.cpp         \
          tests/test_h5.cpp       \
          include/Helpers.hpp     \
          include/SM_Maponi.hpp   \
          include/SM_Standard.hpp \
          include/SMWB.hpp        \
          include/Woodbury.hpp
</pre>
</div>

<p>
and run <code>make dist</code> again to rebuild the source distribution. Note
that the current Makefile detects that <code>Makefile.am</code> has changed, so
it re-runs <b>Automake</b> and also re-generates the Makefile using
<code>config.status</code> before producing the updated archive.
</p>

<div class="org-src-container">
<pre class="src src-bash">$ tar --list -f sherman-morrison-0.0.1.tar.gz
sherman-morrison-0.0.1/
sherman-morrison-0.0.1/include/
sherman-morrison-0.0.1/include/Helpers.hpp
sherman-morrison-0.0.1/include/SM_Maponi.hpp
sherman-morrison-0.0.1/include/SM_Standard.hpp
sherman-morrison-0.0.1/include/SMWB.hpp
sherman-morrison-0.0.1/include/Woodbury.hpp
sherman-morrison-0.0.1/m4/
sherman-morrison-0.0.1/m4/ax_lib_hdf5.m4
sherman-morrison-0.0.1/src/
sherman-morrison-0.0.1/src/SM_Maponi.cpp
sherman-morrison-0.0.1/src/SM_Standard.cpp
sherman-morrison-0.0.1/src/Woodbury.cpp
sherman-morrison-0.0.1/src/SMWB.cpp
sherman-morrison-0.0.1/src/Helpers.cpp
sherman-morrison-0.0.1/tests/
sherman-morrison-0.0.1/tests/test_h5.cpp
sherman-morrison-0.0.1/Makefile.am
sherman-morrison-0.0.1/configure
sherman-morrison-0.0.1/configure.ac
sherman-morrison-0.0.1/aclocal.m4
sherman-morrison-0.0.1/Makefile.in
sherman-morrison-0.0.1/compile
sherman-morrison-0.0.1/depcomp
sherman-morrison-0.0.1/install-sh
sherman-morrison-0.0.1/missing
</pre>
</div>

<p>
We can now test again the source distribution:
</p>

<div class="org-src-container">
<pre class="src src-bash">$ make distcheck
[...]
make[1]: Entering directory <span style="color: #8b2252;">'/home/test/Sherman-Morrison-0.1-demo/sherman-morrison-0.0.1/_build/sub'</span>
<span style="color: #a0522d;">depbase</span>=<span style="color: #ff00ff;">`echo src/SM_Maponi.o | sed 's|[^/]*$|.deps/&amp;|;s|\.o$||'`</span>;<span style="color: #8b2252;">\</span>
g++ -DPACKAGE_NAME=<span style="color: #8b2252;">\"</span>sherman-morrison<span style="color: #8b2252;">\"</span> -DPACKAGE_TARNAME=<span style="color: #8b2252;">\"</span>sherman-morrison<span style="color: #8b2252;">\"</span> -DPACKAGE_VERSION=<span style="color: #8b2252;">\"</span>0.0.1<span style="color: #8b2252;">\"</span> -DPACKAGE_STRING=<span style="color: #8b2252;">\"</span>sherman-morrison<span style="color: #8b2252;">\ </span>0.0.1<span style="color: #8b2252;">\"</span> -DPACKAGE_BUGREPORT=<span style="color: #8b2252;">\"\"</span> -DPACKAGE_URL=<span style="color: #8b2252;">\"\"</span> -DPACKAGE=<span style="color: #8b2252;">\"</span>sherman-morrison<span style="color: #8b2252;">\"</span> -DVERSION=<span style="color: #8b2252;">\"</span>0.0.1<span style="color: #8b2252;">\"</span> -DSTDC_HEADERS=1 -DHAVE_SYS_TYPES_H=1 -DHAVE_SYS_STAT_H=1 -DHAVE_STDLIB_H=1 -DHAVE_STRING_H=1 -DHAVE_MEMORY_H=1 -DHAVE_STRINGS_H=1 -DHAVE_INTTYPES_H=1 -DHAVE_STDINT_H=1 -DHAVE_UNISTD_H=1 -DHAVE_HDF5=1 -I. -I../..   -I/usr/include -I/usr/include/hdf5/serial  -I./include/  -g -O2 -std=c++11 -MT src/SM_Maponi.o -MD -MP -MF $<span style="color: #a0522d;">depbase</span>.Tpo -c -o src/SM_Maponi.o ../../src/SM_Maponi.cpp &amp;&amp;<span style="color: #8b2252;">\</span>
mv -f $<span style="color: #a0522d;">depbase</span>.Tpo $<span style="color: #a0522d;">depbase</span>.Po
../../src/SM_Maponi.cpp:4:10: fatal error: SM_Maponi.hpp: No such file or directory
 #<span style="color: #b22222;">include "SM_Maponi.hpp"</span>
          ^~~~~~~~~~~~~~~
compilation terminated.
make[1]: *** [Makefile:449: src/SM_Maponi.o] Error 1
make[1]: Leaving directory <span style="color: #8b2252;">'/home/test/Sherman-Morrison-0.1-demo/sherman-morrison-0.0.1/_build/sub'</span>
make: *** [Makefile:613: distcheck] Error 1
</pre>
</div>

<p>
Oh no! Still the same error! But now we know that the header file is
present.
</p>

<div class="question">
<p>
Can you figure out what is wrong now?
</p>

</div>

<p>
Inspecting the compilation line, we notice that the compilation
takes place in the <code>sherman-morrison-0.0.1/_build/sub</code> directory.
<b>Automake</b> is now trying to make an <i>out of source</i> build: building
the package outside of the source directory. In the previous
tutorial, we have introduced <code>-I./include</code> to the <code>CPPFLAGS</code>
variable in the <code>configure.ac</code> file. Using such a relative path
implies that we are running make in the source directory, which is
not desirable if you want to be able to make RPM packages for instance.
</p>

<p>
So now we need to move this definition into the <code>Makefile.am</code> file.
<code>configure.ac</code> becomes:
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span style="color: #a0522d;">CPPFLAGS</span>=<span style="color: #8b2252;">"${</span><span style="color: #a0522d;">HDF5_CPPFLAGS</span><span style="color: #8b2252;">} ${</span><span style="color: #a0522d;">CPPFLAGS</span><span style="color: #8b2252;">}"</span>
</pre>
</div>

<p>
and <code>Makefile.am</code> has the extra line:
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span style="color: #a0522d;">AM_CPPFLAGS</span> =  -I$(<span style="color: #a0522d;">srcdir</span>)/include/
</pre>
</div>

<p>
You can remark that we have now introduced the <code>srcdir</code> variable
which points the the root of the source. For <i>in source</i> builds,
<code>srcdir</code> is <code>.</code> but for <i>out of source</i> builds it is set to the
relative path to the root. If for some reason you need the absolute
path, you can use <code>abs_srcdir</code> instead.
</p>

<p>
Now, let us test our source distribution:
</p>

<div class="org-src-container">
<pre class="src src-bash">$ make distcheck
[...]
========================================================
sherman-morrison-0.0.1 archives ready for distribution:
sherman-morrison-0.0.1.tar.gz
========================================================
</pre>
</div>

<p>
Success! the distribution compiles and we now have something that we
can give to our users!
</p>

<div class="tip">
<p>
You can specify which tarball format to use with <code>make dist</code> by
adding the <code>dist-zip</code>, <code>dist-bzip2</code>, <code>dist-xz</code>, &#x2026; option to the
<code>AM_INIT_AUTOMAKE</code> macro in <code>configure.ac</code>
</p>

</div>
</div>
</div>
</div>
<div id="outline-container-org434e7b1" class="outline-2">
<h2 id="org434e7b1"><span class="section-number-2">6</span> Automake Syntax</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-org2cdd564" class="outline-3">
<h3 id="org2cdd564"><span class="section-number-3">6.1</span> Variables</h3>
<div class="outline-text-3" id="text-6-1">
<p>
Here is the list of the main variables that are used in
<code>Makefile.am</code>:
</p>

<dl class="org-dl">
<dt><code>AM_CPPFLAGS = -I/dir1 -I/dir2 -I$(srcdir)/include ...</code></dt><dd>List the
<code>-I</code> flags that need to be passed to the compiler to find the
include files</dd>
<dt><code>AM_LDFLAGS = -L/dir1 -L/dir2 ...</code></dt><dd>Flags to be passed to the linker</dd>
<dt><code>LDADD = file.o $(top_builddir)/dir1/libmylib.la -lmylib ...</code></dt><dd>Object
files and built libraries to be linked with all executables</dd>
<dt><code>CLEANFILES = my_file.mod ...</code></dt><dd>List of extra files to remove
with <code>make clean</code></dd>
<dt><code>EXTRA_DIST</code></dt><dd><p>
Additional files to be  shipped with the binary distribution.
</p>

<div class="note">
<p>
User variables such as <code>CFLAGS</code> or <code>CPPFLAGS</code> should never be
overwritten in a <code>Makefile.am</code>. This explains why these variables have
the <code>AM_</code> prefix.
</p>

</div></dd>
</dl>
</div>
</div>

<div id="outline-container-orga57a59d" class="outline-3">
<h3 id="orga57a59d"><span class="section-number-3">6.2</span> Product list variables</h3>
<div class="outline-text-3" id="text-6-2">
<p>
In the previous section, we have seen two special variables
<code>bin_PROGRAMS</code> and <code>test_h5_SOURCES</code>.
</p>

<p>
<code>bin_PROGRAMS</code> contains the names of the programs we are building,
and these will be installed in <code>$(exec_prefix)/bin</code> upon invocation of
<code>make install</code>.
</p>

<p>
<i>Product list variables</i> (PLV) conform to the following template:
</p>

<pre class="example">
[modifier-list]prefix_PRIMARY = product1 product2 ... productN
</pre>
</div>

<div id="outline-container-orga73286f" class="outline-4">
<h4 id="orga73286f"><span class="section-number-4">6.2.1</span> Installation location prefixes</h4>
<div class="outline-text-4" id="text-6-2-1">
<p>
The <code>prefix</code> can be an <i>installation location prefix</i>, as in for
example <code>bin_PROGRAMS</code> or <code>lib_LIBRARIES</code>. The <code>prefix</code> corresponds
to a variable defining a directory chopping off the <code>dir</code>
suffix. For example, the <code>bin</code> prefix corresponds to the <code>$(bindir)</code>
variable. You can make your own prefix, for example:
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span style="color: #a0522d;">gpudir</span> = $(<span style="color: #a0522d;">exec_prefix</span>)/gpu
<span style="color: #a0522d;">gpu_PROGRAMS</span> = cublas_test
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc8eded5" class="outline-4">
<h4 id="orgc8eded5"><span class="section-number-4">6.2.2</span> Other prefixes</h4>
<div class="outline-text-4" id="text-6-2-2">
<dl class="org-dl">
<dt><code>noinst</code></dt><dd>Products that should not be installed</dd>
<dt><code>check</code></dt><dd>Products that should be built for testing</dd>
<dt><code>EXTRA</code></dt><dd>Products that are built conditionally</dd>
</dl>
</div>
</div>

<div id="outline-container-org299a0b5" class="outline-4">
<h4 id="org299a0b5"><span class="section-number-4">6.2.3</span> Primaries</h4>
<div class="outline-text-4" id="text-6-2-3">
<p>
A primary is a class of products. This defines the rules to create
in the Makefile to satisfy the needs of the product.
</p>

<dl class="org-dl">
<dt><code>PROGRAMS</code></dt><dd>Create rules to build the binary executables</dd>
<dt><code>LIBRARIES</code></dt><dd>Create rules to build the libraries</dd>
<dt><code>LTLIBRARIES</code></dt><dd>Create rules to build the libraries using <b>Libtool</b></dd>
<dt><code>SCRIPTS</code></dt><dd>Create rules to install the scripts</dd>
<dt><code>DATA</code></dt><dd>Arbitrary files (documentation, test data, etc)</dd>
<dt><code>HEADERS</code></dt><dd>Header files to be installed</dd>
</dl>
</div>
</div>
</div>

<div id="outline-container-org7e2a50e" class="outline-3">
<h3 id="org7e2a50e"><span class="section-number-3">6.3</span> Product source variables</h3>
<div class="outline-text-3" id="text-6-3">
<p>
In our example, the name of the program is <code>test_h5</code>, so by defining
<code>test_h5_SOURCES</code> we can list the source files needed to build
<code>test_h5</code>. Automake will then do everything necessary in the
<code>Makefile.in</code> to build <code>test_h5</code>.
</p>

<p>
<i>Product source variables</i> (PSV) conform to the following template:
</p>

<pre class="example">
[modifier-list]product_SOURCES = file1 file2 ... fileN
</pre>

<p>
<code>product</code> refers to the built product. If the product contains
special characters, these should be replaced by underscores. For
example:
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span style="color: #a0522d;">lib_LIBRARIES</span> = libc++.a
<span style="color: #a0522d;">libc___a_SOURCES</span> = ...
</pre>
</div>
</div>
</div>

<div id="outline-container-org8fefa51" class="outline-3">
<h3 id="org8fefa51"><span class="section-number-3">6.4</span> PLV and PSV modifiers</h3>
<div class="outline-text-3" id="text-6-4">
<p>
Modifiers change the default behavior of the variable. The main
modifiers are <code>dist</code> and <code>nodist</code>, which indicate if the files
should be part of the distributed package or not.
</p>


<div class="exercise">
<p>
Modify the <code>Makefile.am</code> to add the <code>LICENSE</code> file to the source
distribution package, and to install the <code>README.md</code> file into the
documentation directory.
</p>

</div>
</div>
</div>
</div>

<div id="outline-container-org932c970" class="outline-2">
<h2 id="org932c970"><span class="section-number-2">7</span> Testing</h2>
<div class="outline-text-2" id="text-7">
<p>
Automake provides a framework for testing your program. The <code>TEST</code>
variable contains a list of tests to execute when the user runs
<code>make check</code>. The tests should be written such that success
corresponds to an exit code equal to <code>0</code>. An exit status of <code>77</code>
means that the test should be ignored. For all other exit codes, the
test failed.
</p>

<div class="important">
<p>
Once you have added the <code>TEST</code> variable to <code>Makefile.am</code>, you need to
run <code>autoreconf -i</code>. It will detect that you will need the testing
framework and install it in your package.
</p>

</div>

<div class="exercise">
<ol class="org-ol">
<li>Provide a dummy test for the current package which always succeeds,
and another one which always fails.</li>
<li>Add the tests to the <code>Makefile.am</code></li>
<li>Run <code>make check</code></li>
</ol>

</div>

<div class="note">
<p>
The prefix <code>check</code> is used for products that should only be
built when <code>make check</code> is run.
</p>

</div>

<p>
In <code>Makefile.am</code>, we add
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span style="color: #a0522d;">TESTS</span> = tests/success tests/failure
<span style="color: #a0522d;">check_PROGRAMS</span> = $(<span style="color: #a0522d;">TESTS</span>)

<span style="color: #a0522d;">tests_success_SOURCES</span> = tests/success.cpp
<span style="color: #a0522d;">tests_failure_SOURCES</span> = tests/failure.cpp
</pre>
</div>

<p>
We can now test the package by running
</p>

<div class="org-src-container">
<pre class="src src-bash">$ make check
[...]
PASS: tests/success
FAIL: tests/failure
============================================================================
Testsuite summary for sherman-morrison 0.0.1
============================================================================
# <span style="color: #b22222;">TOTAL: 2</span>
# <span style="color: #b22222;">PASS:  1</span>
# <span style="color: #b22222;">SKIP:  0</span>
# <span style="color: #b22222;">XFAIL: 0</span>
# <span style="color: #b22222;">FAIL:  1</span>
# <span style="color: #b22222;">XPASS: 0</span>
# <span style="color: #b22222;">ERROR: 0</span>
============================================================================
See ./test-suite.log
============================================================================
</pre>
</div>

<p>
which results in an error.
</p>

<p>
Sometimes, you know that a test fails, but you don't have time to
fix it right away. You can add this test to the <code>XFAIL_TESTS</code>
variable, which contains the list of tests that are expected to
fail. Similarly, the <code>XPASS_TESTS</code> are tests that are not supposed
to pass.
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span style="color: #a0522d;">TESTS</span> = tests/success tests/failure
<span style="color: #a0522d;">XFAIL_TESTS</span> = tests/failure
<span style="color: #a0522d;">check_PROGRAMS</span> = $(<span style="color: #a0522d;">TESTS</span>)

<span style="color: #a0522d;">tests_success_SOURCES</span> = tests/success.cpp
<span style="color: #a0522d;">tests_failure_SOURCES</span> = tests/failure.cpp
</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash">PASS: tests/success
XFAIL: tests/failure
============================================================================
Testsuite summary for sherman-morrison 0.0.1
============================================================================
# <span style="color: #b22222;">TOTAL: 2</span>
# <span style="color: #b22222;">PASS:  1</span>
# <span style="color: #b22222;">SKIP:  0</span>
# <span style="color: #b22222;">XFAIL: 1</span>
# <span style="color: #b22222;">FAIL:  0</span>
# <span style="color: #b22222;">XPASS: 0</span>
# <span style="color: #b22222;">ERROR: 0</span>
============================================================================
</pre>
</div>

<p>
Now, when we run <code>make distcheck</code>, the tests will also be run when
building the source distribution package.
</p>
</div>
</div>

<div id="outline-container-org2904ecc" class="outline-2">
<h2 id="org2904ecc"><span class="section-number-2">8</span> Using pkg-config</h2>
<div class="outline-text-2" id="text-8">
<p>
When your software depends on external libraries and you try to
compile it on an unknown system, you need to figure out what are the
correct flags to access the include files of the library and how to
link it. `configure` will try to find the libraries in the standard
locations, but if the configuration is a bit exotic, this will
require some extra knowledge.
</p>

<p>
At the moment you install a library on a system, you have all the
knowledge required to use this library in other software: what
compiler options to add. All this information can be saved in a
file with the suffix <code>.pc</code> stored in a standard location such as
<code>/usr/lib/pkgconfig</code>, and this information can be retrieved later on
with the <code>pkg-config</code> command.
</p>

<p>
Let's assume you have compiled and installed the <i>QMCkl</i>
library. The library will produce the system-specific file
<code>/usr/local/lib/pkgconfig/qmckl.pc</code>:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #a0522d;">prefix</span>=/usr/local
<span style="color: #a0522d;">exec_prefix</span>=${<span style="color: #a0522d;">prefix</span>}
<span style="color: #a0522d;">includedir</span>=${<span style="color: #a0522d;">prefix</span>}/include
<span style="color: #a0522d;">libdir</span>=${<span style="color: #a0522d;">exec_prefix</span>}/lib


Name: qmckl
Description: Quantum Monte Carlo kernel library
URL: https://github.com/trex-coe/qmckl
Version: 0.1.1
Cflags:  -I${<span style="color: #a0522d;">includedir</span>}
Libs: -L${<span style="color: #a0522d;">libdir</span>} -lqmckl
Libs.private:  -L/home/scemama/TREX/trexio/_install/lib -L/usr/lib/x86_64-linux-gnu/hdf5/serial -ltrexio -lhdf5 -lpthread -lm
</pre>
</div>

<p>
This file tells you that you need to include the flag
<code>-I/usr/local/include</code> to the C preprocessor (the <code>CPPFLAGS</code>
variable), and the <code>-L/usr/local/lib -lqmckl</code> flag at the link stage
(the <code>LDFLAGS</code> variable) if you want to use the dynamically linked library.
</p>

<p>
This information can be accessed using the <code>pkg-config</code> command:
</p>
<div class="org-src-container">
<pre class="src src-bash">$ pkg-config --cflags qmckl
-I/usr/local/include/

$ pkg-config --libs qmckl
-L/usr/local/lib -lqmckl
</pre>
</div>

<p>
In your <code>configure.ac</code> file, you can simply use
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #0000ff;">PKG_CHECK_MODULES</span>([qmckl])
<span style="color: #a0522d;">CFLAGS</span>=<span style="color: #8b2252;">"${CFLAGS} `pkg-config --cflags qmckl`"</span>
<span style="color: #a0522d;">LDFLAGS</span>=<span style="color: #8b2252;">"${LDFLAGS} `pkg-config --libs qmckl`"</span>
</pre>
</div>

<p>
to include the appropriate flags. The <code>PKG_CHECK_MODULE</code> macro
will fail if pkg-config is not installed on the system, or if the
<code>qmckl.pc</code> file is not found.
</p>

<div class="tip">
<p>
The pkg-config files are searched in the directories defined by the
<code class="src src-bash">PKG_CONFIG_PATH</code> environment variable.
</p>

</div>

<div class="seealso">
<ul class="org-ul">
<li><a href="https://people.freedesktop.org/~dbn/pkg-config-guide.html">Guide to pkg-config</a></li>
<li><a href="https://autotools.io/pkgconfig/index.html">Dependency discovery  pkg-config</a></li>
</ul>

</div>
</div>
</div>

<div id="outline-container-orgfb6ee51" class="outline-2">
<h2 id="orgfb6ee51"><span class="section-number-2">9</span> Back to Autoconf</h2>
<div class="outline-text-2" id="text-9">
</div>
<div id="outline-container-org97da41e" class="outline-3">
<h3 id="org97da41e"><span class="section-number-3">9.1</span> Searching for dependencies</h3>
<div class="outline-text-3" id="text-9-1">
</div>
<div id="outline-container-orgaca019d" class="outline-4">
<h4 id="orgaca019d"><span class="section-number-4">9.1.1</span> C definitions</h4>
<div class="outline-text-4" id="text-9-1-1">
<p>
If you are using the C/C++ preprocessor, you can enable <i>conditional
compilation</i> in your code. This is particularly frequent when you
use MPI. For example:
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #483d8b;">#ifdef</span> HAVE_MPI
  rc = mpi_reduce(...)
<span style="color: #483d8b;">#endif</span>
</pre>
</div>

<p>
allows you to activate the MPI calls only when the <code>-DHAVE_MPI</code>
option is passed in the command line, or if an included header file
defines the <code>HAVE_MPI</code> variable.
</p>

<p>
In the <code>configure.ac</code> file, the <code>AC_CONFIG_HEADERS</code> macro produces a
configuration header file which will enable the definition of C
preprocessor variables. The <code>AC_DEFINE</code> macro in <code>configure.ac</code>
allows to create C definitions.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #0000ff;">AC_CONFIG_HEADERS</span>([include/config.h])

<span style="color: #a020f0;">case</span> $<span style="color: #a0522d;">CC</span><span style="color: #a020f0;"> in</span>
    *icc*)
       AC_DEFINE([HAVE_INTEL], [], [Define if using the Intel compiler]) ;;
    *) ;;
<span style="color: #a020f0;">esac</span>
</pre>
</div>

<p>
Will produce the following in <code>include/config.h</code> if the Intel
compiler is used:
</p>

<div class="org-src-container">
<pre class="src src-c">/* <span style="color: #b22222;">Define if using the Intel compiler </span>*/
<span style="color: #483d8b;">#define</span> <span style="color: #a0522d;">HAVE_INTEL</span> /**/
</pre>
</div>

<p>
and this code if not
</p>

<div class="org-src-container">
<pre class="src src-c">/* <span style="color: #b22222;">Define if using the Intel compiler </span>*/
/* <span style="color: #b22222;">#undef HAVE_INTEL </span>*/
</pre>
</div>

<p>
Similarly, you can give values to the definitions, to pass values
determined at configuration time, like the installation <code>prefix</code>
to locate the configuration files for instance:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #0000ff;">AC_DEFINE_UNQUOTED</span>([PREFIX_DIR], [<span style="color: #8b2252;">"`echo $prefix`"</span>], [Installation prefix])
</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash">$ ./configure --prefix=/usr/local
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c">/* <span style="color: #b22222;">Installation prefix </span>*/
<span style="color: #483d8b;">#define</span> <span style="color: #a0522d;">PREFIX_DIR</span> <span style="color: #8b2252;">"/usr/local"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org13cbbf7" class="outline-4">
<h4 id="org13cbbf7"><span class="section-number-4">9.1.2</span> Checking for headers</h4>
<div class="outline-text-4" id="text-9-1-2">
<p>
You may need to check if some headers are available. For this, you
can use the <code>AC_CHECK_HEADERS</code> macros:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #0000ff;">AC_CHECK_HEADERS</span> ([header-file ...], [action-if-found], [action-if-
not-found], [includes])
</pre>
</div>

<p>
For example, one can remark in our example that the
<code>include/Helpers.hpp</code> requires the <code>mkl_lapacke.h</code> header which is
not standard. We can introduce a check for it, and force the
failure of <code>configure</code> if it is not found.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #0000ff;">AC_CHECK_HEADERS</span>([mkl_lapacke.h], [],
                [AC_MSG_ERROR([Unable to find mkl_lapacke.h])])
</pre>
</div>

<div class="tip">
<p>
If later on in <code>configure.ac</code> you need to remember if you have or
not the header, the result is stored in <code>ac_cv_header_&lt;header_file&gt;</code>.
</p>

</div>
</div>
</div>

<div id="outline-container-org6c9ee1b" class="outline-4">
<h4 id="org6c9ee1b"><span class="section-number-4">9.1.3</span> Checking for libraries</h4>
<div class="outline-text-4" id="text-9-1-3">
<p>
As we have seen in Part I, we can look in the archive of <b>Autoconf</b>
macros to see if we find a macro for searching a particular library.
If not, then we can use the <code>AC_SEARCH_LIBS</code> macro:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #0000ff;">AC_SEARCH_LIBS</span> (<span style="color: #a020f0;">function</span>, search-libs, [action-if-found],
                [action-if-not-found], [other-libraries])
</pre>
</div>

<p>
<code>function</code> is a function provided by the library, and <code>search-libs</code>
is a list of libraries that can provide the function we search for
(for example <code>[mpich openmpi]</code>). <code>other-libraries</code> contains the
list of other libraries to link in the test that checks if the
requested library is found.
</p>

<p>
If the library is found, it will be inserted into the <code>LIBS</code> variable.
</p>

<div class="tip">
<p>
If later on in <code>configure.ac</code> you need to remember if you have or
not the library, the result is stored in <code>ac_cv_search_&lt;function&gt;</code>.
</p>

</div>
</div>
</div>

<div id="outline-container-orge523e51" class="outline-4">
<h4 id="orge523e51"><span class="section-number-4">9.1.4</span> Checking for external programs</h4>
<div class="outline-text-4" id="text-9-1-4">
<p>
You package might need some other programs to be functional. For
example, you might need a Python interpreter for some scripts.
The presence of other programs can be checked with the
<code>AC_CHECK_PROGS</code> macro:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #0000ff;">AC_CHECK_PROGS</span>(variable, progs-to-check-for, [value-if-not-found], [path = &#8216;$<span style="color: #a0522d;">PATH</span>&#8217;])
</pre>
</div>

<p>
The following exampl checks for a Python interpreter and saves the
result in the <code>PYTHON</code> variable:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #0000ff;">AC_CHECK_PROGS</span>(PYTHON, [python3 python], [not_found])
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgc9fc215" class="outline-3">
<h3 id="orgc9fc215"><span class="section-number-3">9.2</span> Printing</h3>
<div class="outline-text-3" id="text-9-2">
<p>
The following macros will be useful to display messages to the
users running configure:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left"><code>AC_MSG_CHECKING (feature-description)</code></td>
<td class="org-left">Inform the user that <code>configure</code> is checking something</td>
</tr>

<tr>
<td class="org-left"><code>AC_MSG_RESULT (result-description)</code></td>
<td class="org-left">Return to the user the results of a check</td>
</tr>

<tr>
<td class="org-left"><code>AC_MSG_ERROR (error-description, [exit-status = $?/1])</code></td>
<td class="org-left">Make <code>configure</code> fail with an error message</td>
</tr>

<tr>
<td class="org-left"><code>AC_MSG_NOTICE(message)</code></td>
<td class="org-left">Print the message</td>
</tr>

<tr>
<td class="org-left"><code>AC_MSG_WARN (problem-description)</code></td>
<td class="org-left">Inform the user of a possible problem</td>
</tr>
</tbody>
</table>
</div>
</div>


<div id="outline-container-org9dca89a" class="outline-3">
<h3 id="org9dca89a"><span class="section-number-3">9.3</span> Using external software</h3>
<div class="outline-text-3" id="text-9-3">
<p>
The usage of an external software can be controlled by the user by
specifying some options to the <code>configure</code> script:
<code>--with-&lt;package&gt;=&lt;arg&gt;</code> or <code>--without-&lt;package&gt;</code>.
</p>

<p>
Let us now add the possibility to compile our program with or
without MPI. To do that, we start by adding to the <code>configure.ac</code>
file:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #0000ff;">AC_ARG_WITH</span>(mpi, [AS_HELP_STRING([--with-mpi=yes/no], [Activate MPI])])
</pre>
</div>

<p>
After regenerating the <code>configure</code> script, we see that now
<code>configure --help</code> shows the <code>--with-mpi</code> option.
If the <code>--with-mpi</code> is absent of the command line, the <code>with_mpi</code>
variable will be empty. Otherwise, it will contain <code>yes</code>.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #0000ff;">AC_ARG_WITH</span>(mpi, [AS_HELP_STRING([--with-mpi], [Activate MPI])])
<span style="color: #0000ff;">AS_IF</span>([test <span style="color: #8b2252;">"x$with_mpi"</span> == <span style="color: #8b2252;">"xyes"</span>], [
  AC_DEFINE([HAVE_MPI], [], [MPI is activated])
  AC_MSG_NOTICE([MPI is configured])
  AC_CHECK_PROGS(MPICC, [mpicc])
  AC_CHECK_PROGS(MPICXX, [mpicxx])
  <span style="color: #a0522d;">CC</span>=$<span style="color: #a0522d;">MPICC</span>
  <span style="color: #a0522d;">CXX</span>=$<span style="color: #a0522d;">MPICXX</span>
])
</pre>
</div>

<div class="seealso">
<ul class="org-ul">
<li><a href="https://autotools.io/autoconf/arguments.html">Adding Options</a></li>
</ul>

</div>
</div>
</div>
</div>

<div id="outline-container-orge334b43" class="outline-2">
<h2 id="orge334b43"><span class="section-number-2">10</span> Autoscan</h2>
<div class="outline-text-2" id="text-10">
<p>
<b>Autoscan</b> scans the source tree and tries to fix vulnerabilities
 encountered in the <code>configure.ac</code>.
</p>

<div class="org-src-container">
<pre class="src src-bash">$ autoscan
configure.ac: warning: missing AC_CHECK_FUNCS([memset]) wanted by: include/Helpers.hpp:86
configure.ac: warning: missing AC_CHECK_FUNCS([pow]) wanted by: include/Helpers.hpp:148
configure.ac: warning: missing AC_CHECK_FUNCS([sqrt]) wanted by: include/Helpers.hpp:262
configure.ac: warning: missing AC_CHECK_HEADER_STDBOOL wanted by: include/Helpers.hpp:192
</pre>
</div>

<p>
Here, <b>Autoscan</b> has detected that we are using the <code>memset</code>, <code>pow</code>
and <code>sqrt</code> functions. It is safer to check that these functions are
available and functional. We simply need to follow the instructions
given by <b>Autoscan</b>.
</p>

<div class="tip">
<p>
If you do it at the very beginning of your transition to
<b>Autotools</b>, <code>autoscan</code> will provide you a file named
<code>configure.scan</code> which is a good starting point for creating the
<code>configure.ac</code> file.
</p>

</div>
</div>
</div>

<div id="outline-container-org3e46518" class="outline-2">
<h2 id="org3e46518"><span class="section-number-2">11</span> More about maintainer mode</h2>
<div class="outline-text-2" id="text-11">
</div>
<div id="outline-container-org0e26bca" class="outline-3">
<h3 id="org0e26bca"><span class="section-number-3">11.1</span> Automatic maintainer/user switching</h3>
<div class="outline-text-3" id="text-11-1">
<p>
It is convenient to define a variable that allows to know if the
configuration should be for a maintainer or for an end user. The
simplest recipe is to check for the existence of the <code>.git</code>
directory at the root of the project. If it exists, we are not in
the source distribution but in a directory obtained by <code>git clone</code>.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #0000ff;">AC_CHECK_FILE</span>([.git], [<span style="color: #a0522d;">IS_MAINTAINER</span>=<span style="color: #8b2252;">"yes"</span>], [<span style="color: #a0522d;">IS_MAINTAINER</span>=<span style="color: #8b2252;">"no"</span>])
</pre>
</div>

<p>
Then, the commands specific to maintainer mode can be executed in
<code>configure.ac</code> by checking the value of this variable:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #0000ff;">AS_IF</span>([test <span style="color: #8b2252;">"$IS_MAINTAINER"</span> == <span style="color: #8b2252;">"yes"</span>],
      [AC_MSG_NOTICE([Maintainer configuration])],
      [AC_MSG_NOTICE([User configuration])])
</pre>
</div>

<p>
To propagate this knowledge to <code>Makefile.am</code>, you can use in <code>configure.ac</code>
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #0000ff;">AM_CONDITIONAL</span>([IS_MAINTAINER], [test <span style="color: #8b2252;">"$IS_MAINTAINER"</span> == <span style="color: #8b2252;">"yes"</span>])
</pre>
</div>

<p>
and then, in <code>Makefile.am</code>
</p>

<div class="org-src-container">
<pre class="src src-makefile">if IS_MAINTAINER
[...]
endif
</pre>
</div>
</div>
</div>

<div id="outline-container-org6511f1e" class="outline-3">
<h3 id="org6511f1e"><span class="section-number-3">11.2</span> Example: Saving the Git Hash</h3>
<div class="outline-text-3" id="text-11-2">
<p>
Inside <code>configure.ac</code>, it is rather simple to get the git hash and
store it into a defined variable:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #a0522d;">GIT_HASH</span>=<span style="color: #ff00ff;">`git log | head -1 | cut -d ' ' -f 2`</span>
</pre>
</div>

<p>
When the distribution package is made, the information relative to
the Git repository is not stored in the tarball. So it will not be
possible to get the Git hash by executing this command for the end
user. The Git hash is available only for maintainers and needs to
be stored somewhere in the distribution package to be propagated to
the users.
</p>

<p>
In <code>configure.ac</code>:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #0000ff;">AS_IF</span>([test <span style="color: #8b2252;">"$IS_MAINTAINER"</span> = <span style="color: #8b2252;">"yes"</span>],
      [<span style="color: #a0522d;">GIT_HASH</span>=<span style="color: #ff00ff;">`git log | head -1 | cut -d ' ' -f 2 | tee ${srcdir}/.git_hash`</span>],
      [<span style="color: #a0522d;">GIT_HASH</span>=<span style="color: #ff00ff;">`cat ${srcdir}/.git_hash`</span>])

<span style="color: #0000ff;">AC_DEFINE_UNQUOTED</span>(GIT_HASH, [<span style="color: #8b2252;">"${GIT_HASH}"</span>], [Git SHA1 Hash])
</pre>
</div>

<p>
In maintainer mode, we fetch the Git hash and store it in
<code>.git_hash</code>. In user mode, we read the content of <code>.git_hash</code>.
Then, we propagate this variable to <code>config.h</code> with
<code>AC_DEFINE_UNQUOTED</code>.
</p>

<p>
In <code>Makefile.am</code>, we add the new file to the source distribution tarball:
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span style="color: #a0522d;">EXTRA_DIST</span> += .git_hash
</pre>
</div>

<p>
and we add rules to always regenerate it in case we make a commit:
</p>

<div class="org-src-container">
<pre class="src src-makefile">if IS_MAINTAINER

<span style="color: #a0522d;">CLEANFILES</span> = .git_hash

<span style="color: #0000ff;">.git_hash</span>: FORCE
        git log | head -1 | cut -d <span style="color: #8b2252;">' '</span> -f 2 &gt; .git_hash

<span style="color: #0000ff;">all</span>: .git_hash

<span style="color: #0000ff;">.PHONY</span>: FORCE
endif
</pre>
</div>
</div>
</div>
</div>



<div id="outline-container-orgefdad9c" class="outline-2">
<h2 id="orgefdad9c"><span class="section-number-2">12</span> Useful links</h2>
<div class="outline-text-2" id="text-12">
<ul class="org-ul">
<li><a href="http://clusterchimps.org/autotools.php">CUDA and GNU Autotools</a></li>
<li><a href="https://www.gnu.org/software/automake/manual/html_node/Multiple-Outputs.html">Handling Tools that Produce Many Outputs</a></li>
<li><a href="https://stackoverflow.com/questions/67460091/autotools-and-fortran-modules/67535762#67535762">Autotools and Fortran Modules</a></li>
<li><a href="https://github.com/TREX-CoE/qmckl">Example: The QMCkl library</a></li>
<li><a href="https://gitlab.inria.fr/starpu/starpu">Example: The StarPU library</a></li>
</ul>

<hr />
<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Evgeny Posenitskiy, Anthony Scemama</p>
<p class="date">Created: 2021-11-08 Mon 19:34</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
